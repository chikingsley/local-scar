# Voice Agent - Docker Compose Stack
# ==================================
#
# Start all services:
#   docker compose up -d
#
# View logs:
#   docker compose logs -f agent
#
# Requirements:
#   - Docker with NVIDIA Container Toolkit
#   - Ollama running on host (or in separate container)
#   - n8n with MCP enabled (optional)
#
# Note: First run downloads Parakeet model (~1.2GB) from HuggingFace

services:
  # ==========================================================================
  # Agent - Pipecat Voice Pipeline with local Parakeet STT
  # ==========================================================================
  agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: voice-agent
    ports:
      - "8765:8765"     # WebRTC signaling (SmallWebRTC)
      - "8889:8889"     # Webhook API
    environment:
      # STT (Parakeet via onnx-asr - runs in container)
      - STT_MODEL=${STT_MODEL:-nemo-parakeet-tdt-0.6b-v3}
      - STT_DEVICE=${STT_DEVICE:-cuda}
      - STT_QUANTIZATION=${STT_QUANTIZATION:-}
      # TTS (Chatterbox container)
      - CHATTERBOX_URL=http://chatterbox:5000
      - TTS_VOICE=${TTS_VOICE:-default}
      # LLM (Ollama on host)
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:8b}
      # MCP/n8n (optional)
      - N8N_MCP_URL=${N8N_MCP_URL:-}
      - N8N_MCP_TOKEN=${N8N_MCP_TOKEN:-}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./agent/prompts:/app/prompts:ro
      - ./voices:/app/voices:ro  # Reference audio for voice cloning
      - parakeet-cache:/root/.cache/huggingface  # Cache downloaded models
    networks:
      - voice-network
    depends_on:
      chatterbox:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 120s  # Model download on first run

  # ==========================================================================
  # Chatterbox - TTS with Voice Cloning
  # ==========================================================================
  chatterbox:
    image: ghcr.io/devnen/chatterbox-tts-server:latest
    container_name: voice-chatterbox
    ports:
      - "5000:5000"
    environment:
      - DEVICE=cuda
      - MODEL=turbo  # or "original" for higher quality
      - DEFAULT_EXAGGERATION=0.5
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      - chatterbox-cache:/app/cache
      - ./voices:/app/voices:ro  # Reference audio for cloning
    networks:
      - voice-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ==========================================================================
  # Frontend - Vite + React
  # ==========================================================================
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: voice-frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_AGENT_URL=http://localhost:8765
      - VITE_WEBHOOK_URL=http://localhost:8889
      - VITE_PORCUPINE_ACCESS_KEY=${PORCUPINE_ACCESS_KEY:-}
    networks:
      - voice-network
    depends_on:
      - agent
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  voice-network:
    driver: bridge

volumes:
  parakeet-cache:
    name: voice-parakeet-cache
  chatterbox-cache:
    name: voice-chatterbox-cache
